# ì›Œí¬í”Œë¡œìš° ì´ë¦„ ì„¤ì •
name: TrelloProject CI/CD
# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œ íŠ¸ë¦¬ê±°í•œ ì‚¬ìš©ìì˜ ì´ë¦„ í‘œì‹œ
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€

# ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–´ë–¤ ì´ë²¤íŠ¸ì—ì„œ ì‹¤í–‰ë  ì§€ ì •ì˜ (ì—¬ê¸°ì„œëŠ” push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ì‹¤í–‰)
on: [push]

jobs:
  # 1. CI Job: ë¹Œë“œ, ì˜ì¡´ì„± ì„¤ì¹˜, íŒŒì¼ í™•ì¸ ë“±ì˜ ì‘ì—… ìˆ˜í–‰
  TrelloProject-CI:
    runs-on: ubuntu-latest # ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰
    steps:
      # í˜„ì¬ ì›Œí¬í”Œë¡œìš°ê°€ ì–´ë–¤ ì´ë²¤íŠ¸ì— ì˜í•´ íŠ¸ë¦¬ê±°ë˜ì—ˆëŠ”ì§€ ì¶œë ¥
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      # í˜„ì¬ ì‹¤í–‰ë˜ê³  ìˆëŠ” ì„œë²„ì˜ ìš´ì˜ì²´ì œ ì •ë³´ ì¶œë ¥
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë¸Œëœì¹˜ì™€ ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„ ì¶œë ¥
      - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      # GitHubì˜ ê³µì‹ ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ
      - name: Check out repository code
        uses: actions/checkout@v4

      # ì½”ë“œê°€ ì²´í¬ì•„ì›ƒ(í´ë¡ )ë˜ì—ˆìŒì„ í™•ì¸í•˜ëŠ” ë©”ì‹œì§€ ì¶œë ¥
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."

      # Node.js í™˜ê²½ ì„¤ì • (ì§€ì •í•œ Node ë²„ì „ ì‚¬ìš©)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.12.0'

      # ì˜ì¡´ì„± ì„¤ì¹˜ (package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì„¤ì¹˜)
      - name: Install Dependencies
        run: npm ci

      # ë¦°íŠ¸ ê²€ì‚¬
      # - name: Run Lint
      #   run: npm run lint

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      # - name: Run Tests
      #   run: npm run test:ci

      # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ ë‚´ì˜ íŒŒì¼ ëª©ë¡ì„ ë‚˜ì—´í•˜ì—¬ ì‹œê°ì ìœ¼ë¡œ í™•ì¸
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}

      # í˜„ì¬ CI Jobì˜ ìƒíƒœë¥¼ ì¶œë ¥ (ì„±ê³µ ì—¬ë¶€ í™•ì¸)
      - run: echo "ğŸ This job's status is ${{ job.status }}."

  # 2. CD Job: CI Jobì´ ì„±ê³µí•œ í›„ ìë™ìœ¼ë¡œ AWS EC2 ì„œë²„ì— ë°°í¬ ìˆ˜í–‰
  TrelloProject-CD:
    needs: TrelloProject-CI # CI Job(TrelloProject-CI)ì´ ì„±ê³µí•œ í›„ ì‹¤í–‰
    runs-on: ubuntu-latest
    environment:
      name: production # GitHub Environmentsë¥¼ ì‚¬ìš©í•  ê²½ìš° production í™˜ê²½ ì§€ì •
      # url: ${{ https://www.yangs.site/ }}  # ë°°í¬ í›„ URLì„ ì¶œë ¥í•˜ë ¤ë©´ ì¶”ê°€ êµ¬ì„± ê°€ëŠ¥ã…Œ
    steps:
      # EC2 ë°°í¬ë¥¼ ìœ„í•´ ì›ê²© ì„œë²„ì— ì ‘ê·¼í•˜ê¸° ì „ì— ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ
      # - name: Check out repository code
      #   uses: actions/checkout@v4

      # # ë°°í¬ ì‹œì—ë„ ë™ì¼í•œ Node.js ë²„ì „ì„ ì‚¬ìš©í•˜ë„ë¡ í™˜ê²½ ì„¤ì •
      # - name: Setup Node.js
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '22.12.0'

      # appleboy/ssh-actionì„ ì‚¬ìš©í•˜ì—¬ AWS EC2 ì„œë²„ì— SSH ì ‘ì† í›„ ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰
      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          # AWS EC2 ì„œë²„ì˜ í˜¸ìŠ¤íŠ¸ëª…(IP ì£¼ì†Œ)ì€ GitHub Secretsì— ì €ì¥ëœ ê°’ì„ ì‚¬ìš©
          host: ${{ secrets.EC2_HOST }} # ì˜ˆ: 13.125.224.60
          username: ubuntu # EC2 ì„œë²„ ì ‘ì† ì‚¬ìš©ì (ë³´í†µ ubuntu)
          key: ${{ secrets.EC2_KEY }} # SSH ì¸ì¦ í‚¤ (PEM ë˜ëŠ” PPK í˜•ì‹)
          port: 22 # SSH í¬íŠ¸ (ê¸°ë³¸ 22)
          script: |
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"  # ì›ê²© ì„œë²„ì—ì„œ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
            cd ~/trelloProject           # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ë¨: $(pwd)"  # ì´ë™ í›„ ë””ë ‰í† ë¦¬ í™•ì¸
            # 3000 í¬íŠ¸ë¡œ ì´ë¯¸ ë™ì‘ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ìˆì„ ê²½ìš°, ì¢…ë£Œí•˜ë„ë¡ ì‹œë„
            lsof -i :3000 || true
            # (í•„ìš”ì‹œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: kill -9 [PID])
            # ì›¹ ì„œë²„ ì‹¤í–‰ (npm run start ëª…ë ¹ì–´ ì‹¤í–‰)
            npm run start
